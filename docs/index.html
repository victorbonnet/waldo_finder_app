<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="tensorflowjs, waldo, detector, tensorflow, ai, neural network" name="keywords">
    <meta content="Waldo Detector" name="description">
    <meta content="Waldo Detector" name="title">

    <title>Waldo Detector</title>
  </head>
  <style>
    body {
      font-family: "Roboto", "Helvetica", "Arial", sans-serif;
      margin-top: 50px;
      margin-left: 50px;
    }
  </style>

  <body>
    <h1>Waldo Detector</h1>
    <button type="button" id="run">Run</button>
    <button type="button" id="toggle">Toggle Image</button>
    <!-- <div>
      <img id="image" width="480" height="640" crossorigin="anonymous"></img>
      <canvas id="canvas" width="480" height="640"></canvas>
    </div> -->

    <div>
      <video id="video" autoplay></video>
      <button type="button" id="snap">Snap Photo</button>
      <canvas id="canvas"></canvas>
    </div>
  </body>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@0.12.5"> </script>
  <script>


    // const imageURL = 'https://raw.githubusercontent.com/victorbonnet/waldo_finder_app/master/docs/waldo.jpg';
    // const image2URL = 'https://raw.githubusercontent.com/victorbonnet/waldo_finder_app/master/docs/waldo2.jpg';

    const GOOGLE_CLOUD_STORAGE_DIR =
      'https://raw.githubusercontent.com/victorbonnet/waldo_finder_app/master/docs/web_model/';
    const MODEL_URL =
        GOOGLE_CLOUD_STORAGE_DIR + 'tensorflowjs_model.pb';
    const WEIGHTS_URL =
        GOOGLE_CLOUD_STORAGE_DIR + 'weights_manifest.json';

    let modelPromise;

    window.onload = () => {
      modelPromise = tf.loadFrozenModel(MODEL_URL, WEIGHTS_URL);

      // Grab elements, create settings, etc.
      var video = document.getElementById('video');

      // Get access to the camera!
      if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        const vgaConstraints = {
          video: {width: {exact: 480}, height: {exact: 640}},
          advanced: [{
            facingMode: "environment"
          }]
        };

        navigator.mediaDevices.getUserMedia(vgaConstraints).then(function(stream) {
            video.src = window.URL.createObjectURL(stream);
            video.play();
        });
      }

    }

    // Elements for taking the snapshot
    var canvas = document.getElementById('canvas');
    var context = canvas.getContext('2d');
    var video = document.getElementById('video');

    // Trigger photo take
    const snap = document.getElementById('snap');
    snap.onclick = () => {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
    };

    // const button = document.getElementById('toggle');
    // button.onclick = () => {
    //   image.src = image.src.endsWith(imageURL) ? image2URL : imageURL;
    // };

    // const image = document.getElementById('image');
    // image.src = imageURL;

    const runButton = document.getElementById('run');
    runButton.onclick = async () => {
      const model = await modelPromise;
      // const pixels = tf.fromPixels(image);
      // const pixels = tf.fromPixels(image).toFloat().expandDims(0);
      const pixels = tf.fromPixels(canvas).toFloat().expandDims(0);
      console.log('model loaded');
      console.time('predict1');

      const res = await model.executeAsync(pixels);
      const boxes = await res[0].data();
      const scores = await res[1].data();
      // const classes = await res[2].data();
      // const numDetect = await res[3].data();

      console.log(boxes)
      console.log(scores)
      // console.log(classes)
      // console.log(numDetect)

      const c = document.getElementById('canvas');
      const context = c.getContext('2d');
      context.drawImage(canvas, 0, 0);
      context.font = '10px Arial';

      scores.forEach(function(score, index) {
        if (score > 0.98) {
          const top = boxes[index];
          const left = boxes[index+1];
          const bottom = boxes[index+2];
          const right = boxes[index+3];

          const minY = top * video.height;
          const minX = left * video.width;
          const maxY = bottom * video.height;
          const maxX = right * video.width;

          context.beginPath();
          context.rect(minX, minY, maxX - minX, maxY - minY);
          context.lineWidth = 2;
          context.strokeStyle = 'blue';
          context.stroke();
        }
      });
    };
  </script>
</html>
